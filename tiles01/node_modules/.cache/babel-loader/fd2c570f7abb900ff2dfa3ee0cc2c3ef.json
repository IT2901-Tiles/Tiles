{"ast":null,"code":"'use strict';\n\nconst AuthProvider = require('./auth_provider').AuthProvider;\n\nconst MongoCredentials = require('./mongo_credentials').MongoCredentials;\n\nconst MongoError = require('../error').MongoError;\n\nconst crypto = require('crypto');\n\nconst http = require('http');\n\nconst maxWireVersion = require('../utils').maxWireVersion;\n\nconst url = require('url');\n\nlet aws4;\n\ntry {\n  aws4 = require('aws4');\n} catch (e) {// don't do anything;\n}\n\nconst ASCII_N = 110;\nconst AWS_RELATIVE_URI = 'http://169.254.170.2';\nconst AWS_EC2_URI = 'http://169.254.169.254';\nconst AWS_EC2_PATH = '/latest/meta-data/iam/security-credentials';\n\nclass MongoDBAWS extends AuthProvider {\n  auth(authContext, callback) {\n    const connection = authContext.connection;\n    const credentials = authContext.credentials;\n\n    if (maxWireVersion(connection) < 9) {\n      callback(new MongoError('MONGODB-AWS authentication requires MongoDB version 4.4 or later'));\n      return;\n    }\n\n    if (aws4 == null) {\n      callback(new MongoError('MONGODB-AWS authentication requires the `aws4` module, please install it as a dependency of your project'));\n      return;\n    }\n\n    if (credentials.username == null) {\n      makeTempCredentials(credentials, (err, tempCredentials) => {\n        if (err) return callback(err);\n        authContext.credentials = tempCredentials;\n        this.auth(authContext, callback);\n      });\n      return;\n    }\n\n    const username = credentials.username;\n    const password = credentials.password;\n    const db = credentials.source;\n    const token = credentials.mechanismProperties.AWS_SESSION_TOKEN;\n    const bson = this.bson;\n    crypto.randomBytes(32, (err, nonce) => {\n      if (err) {\n        callback(err);\n        return;\n      }\n\n      const saslStart = {\n        saslStart: 1,\n        mechanism: 'MONGODB-AWS',\n        payload: bson.serialize({\n          r: nonce,\n          p: ASCII_N\n        })\n      };\n      connection.command(`${db}.$cmd`, saslStart, (err, result) => {\n        if (err) return callback(err);\n        const res = result.result;\n        const serverResponse = bson.deserialize(res.payload.buffer);\n        const host = serverResponse.h;\n        const serverNonce = serverResponse.s.buffer;\n\n        if (serverNonce.length !== 64) {\n          callback(new MongoError(`Invalid server nonce length ${serverNonce.length}, expected 64`));\n          return;\n        }\n\n        if (serverNonce.compare(nonce, 0, nonce.length, 0, nonce.length) !== 0) {\n          callback(new MongoError('Server nonce does not begin with client nonce'));\n          return;\n        }\n\n        if (host.length < 1 || host.length > 255 || host.indexOf('..') !== -1) {\n          callback(new MongoError(`Server returned an invalid host: \"${host}\"`));\n          return;\n        }\n\n        const body = 'Action=GetCallerIdentity&Version=2011-06-15';\n        const options = aws4.sign({\n          method: 'POST',\n          host,\n          region: deriveRegion(serverResponse.h),\n          service: 'sts',\n          headers: {\n            'Content-Type': 'application/x-www-form-urlencoded',\n            'Content-Length': body.length,\n            'X-MongoDB-Server-Nonce': serverNonce.toString('base64'),\n            'X-MongoDB-GS2-CB-Flag': 'n'\n          },\n          path: '/',\n          body\n        }, {\n          accessKeyId: username,\n          secretAccessKey: password,\n          token\n        });\n        const authorization = options.headers.Authorization;\n        const date = options.headers['X-Amz-Date'];\n        const payload = {\n          a: authorization,\n          d: date\n        };\n\n        if (token) {\n          payload.t = token;\n        }\n\n        const saslContinue = {\n          saslContinue: 1,\n          conversationId: 1,\n          payload: bson.serialize(payload)\n        };\n        connection.command(`${db}.$cmd`, saslContinue, err => {\n          if (err) return callback(err);\n          callback();\n        });\n      });\n    });\n  }\n\n}\n\nfunction makeTempCredentials(credentials, callback) {\n  function done(creds) {\n    if (creds.AccessKeyId == null || creds.SecretAccessKey == null || creds.Token == null) {\n      callback(new MongoError('Could not obtain temporary MONGODB-AWS credentials'));\n      return;\n    }\n\n    callback(undefined, new MongoCredentials({\n      username: creds.AccessKeyId,\n      password: creds.SecretAccessKey,\n      source: credentials.source,\n      mechanism: 'MONGODB-AWS',\n      mechanismProperties: {\n        AWS_SESSION_TOKEN: creds.Token\n      }\n    }));\n  } // If the environment variable AWS_CONTAINER_CREDENTIALS_RELATIVE_URI\n  // is set then drivers MUST assume that it was set by an AWS ECS agent\n\n\n  if (process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI) {\n    request(`${AWS_RELATIVE_URI}${process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI}`, (err, res) => {\n      if (err) return callback(err);\n      done(res);\n    });\n    return;\n  } // Otherwise assume we are on an EC2 instance\n  // get a token\n\n\n  request(`${AWS_EC2_URI}/latest/api/token`, {\n    method: 'PUT',\n    json: false,\n    headers: {\n      'X-aws-ec2-metadata-token-ttl-seconds': 30\n    }\n  }, (err, token) => {\n    if (err) return callback(err); // get role name\n\n    request(`${AWS_EC2_URI}/${AWS_EC2_PATH}`, {\n      json: false,\n      headers: {\n        'X-aws-ec2-metadata-token': token\n      }\n    }, (err, roleName) => {\n      if (err) return callback(err); // get temp credentials\n\n      request(`${AWS_EC2_URI}/${AWS_EC2_PATH}/${roleName}`, {\n        headers: {\n          'X-aws-ec2-metadata-token': token\n        }\n      }, (err, creds) => {\n        if (err) return callback(err);\n        done(creds);\n      });\n    });\n  });\n}\n\nfunction deriveRegion(host) {\n  const parts = host.split('.');\n\n  if (parts.length === 1 || parts[1] === 'amazonaws') {\n    return 'us-east-1';\n  }\n\n  return parts[1];\n}\n\nfunction request(uri, options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  options = Object.assign({\n    method: 'GET',\n    timeout: 10000,\n    json: true\n  }, url.parse(uri), options);\n  const req = http.request(options, res => {\n    res.setEncoding('utf8');\n    let data = '';\n    res.on('data', d => data += d);\n    res.on('end', () => {\n      if (options.json === false) {\n        callback(undefined, data);\n        return;\n      }\n\n      try {\n        const parsed = JSON.parse(data);\n        callback(undefined, parsed);\n      } catch (err) {\n        callback(new MongoError(`Invalid JSON response: \"${data}\"`));\n      }\n    });\n  });\n  req.on('error', err => callback(err));\n  req.end();\n}\n\nmodule.exports = MongoDBAWS;","map":{"version":3,"sources":["C:/Users/StuartGO/projects/bachelorOppgave/Tiles/tiles01/node_modules/mongodb/lib/core/auth/mongodb_aws.js"],"names":["AuthProvider","require","MongoCredentials","MongoError","crypto","http","maxWireVersion","url","aws4","e","ASCII_N","AWS_RELATIVE_URI","AWS_EC2_URI","AWS_EC2_PATH","MongoDBAWS","auth","authContext","callback","connection","credentials","username","makeTempCredentials","err","tempCredentials","password","db","source","token","mechanismProperties","AWS_SESSION_TOKEN","bson","randomBytes","nonce","saslStart","mechanism","payload","serialize","r","p","command","result","res","serverResponse","deserialize","buffer","host","h","serverNonce","s","length","compare","indexOf","body","options","sign","method","region","deriveRegion","service","headers","toString","path","accessKeyId","secretAccessKey","authorization","Authorization","date","a","d","t","saslContinue","conversationId","done","creds","AccessKeyId","SecretAccessKey","Token","undefined","process","env","AWS_CONTAINER_CREDENTIALS_RELATIVE_URI","request","json","roleName","parts","split","uri","Object","assign","timeout","parse","req","setEncoding","data","on","parsed","JSON","end","module","exports"],"mappings":"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","sourcesContent":["'use strict';\nconst AuthProvider = require('./auth_provider').AuthProvider;\nconst MongoCredentials = require('./mongo_credentials').MongoCredentials;\nconst MongoError = require('../error').MongoError;\nconst crypto = require('crypto');\nconst http = require('http');\nconst maxWireVersion = require('../utils').maxWireVersion;\nconst url = require('url');\n\nlet aws4;\ntry {\n  aws4 = require('aws4');\n} catch (e) {\n  // don't do anything;\n}\n\nconst ASCII_N = 110;\nconst AWS_RELATIVE_URI = 'http://169.254.170.2';\nconst AWS_EC2_URI = 'http://169.254.169.254';\nconst AWS_EC2_PATH = '/latest/meta-data/iam/security-credentials';\n\nclass MongoDBAWS extends AuthProvider {\n  auth(authContext, callback) {\n    const connection = authContext.connection;\n    const credentials = authContext.credentials;\n\n    if (maxWireVersion(connection) < 9) {\n      callback(new MongoError('MONGODB-AWS authentication requires MongoDB version 4.4 or later'));\n      return;\n    }\n\n    if (aws4 == null) {\n      callback(\n        new MongoError(\n          'MONGODB-AWS authentication requires the `aws4` module, please install it as a dependency of your project'\n        )\n      );\n\n      return;\n    }\n\n    if (credentials.username == null) {\n      makeTempCredentials(credentials, (err, tempCredentials) => {\n        if (err) return callback(err);\n\n        authContext.credentials = tempCredentials;\n        this.auth(authContext, callback);\n      });\n\n      return;\n    }\n\n    const username = credentials.username;\n    const password = credentials.password;\n    const db = credentials.source;\n    const token = credentials.mechanismProperties.AWS_SESSION_TOKEN;\n    const bson = this.bson;\n\n    crypto.randomBytes(32, (err, nonce) => {\n      if (err) {\n        callback(err);\n        return;\n      }\n\n      const saslStart = {\n        saslStart: 1,\n        mechanism: 'MONGODB-AWS',\n        payload: bson.serialize({ r: nonce, p: ASCII_N })\n      };\n\n      connection.command(`${db}.$cmd`, saslStart, (err, result) => {\n        if (err) return callback(err);\n\n        const res = result.result;\n        const serverResponse = bson.deserialize(res.payload.buffer);\n        const host = serverResponse.h;\n        const serverNonce = serverResponse.s.buffer;\n        if (serverNonce.length !== 64) {\n          callback(\n            new MongoError(`Invalid server nonce length ${serverNonce.length}, expected 64`)\n          );\n          return;\n        }\n\n        if (serverNonce.compare(nonce, 0, nonce.length, 0, nonce.length) !== 0) {\n          callback(new MongoError('Server nonce does not begin with client nonce'));\n          return;\n        }\n\n        if (host.length < 1 || host.length > 255 || host.indexOf('..') !== -1) {\n          callback(new MongoError(`Server returned an invalid host: \"${host}\"`));\n          return;\n        }\n\n        const body = 'Action=GetCallerIdentity&Version=2011-06-15';\n        const options = aws4.sign(\n          {\n            method: 'POST',\n            host,\n            region: deriveRegion(serverResponse.h),\n            service: 'sts',\n            headers: {\n              'Content-Type': 'application/x-www-form-urlencoded',\n              'Content-Length': body.length,\n              'X-MongoDB-Server-Nonce': serverNonce.toString('base64'),\n              'X-MongoDB-GS2-CB-Flag': 'n'\n            },\n            path: '/',\n            body\n          },\n          {\n            accessKeyId: username,\n            secretAccessKey: password,\n            token\n          }\n        );\n\n        const authorization = options.headers.Authorization;\n        const date = options.headers['X-Amz-Date'];\n        const payload = { a: authorization, d: date };\n        if (token) {\n          payload.t = token;\n        }\n\n        const saslContinue = {\n          saslContinue: 1,\n          conversationId: 1,\n          payload: bson.serialize(payload)\n        };\n\n        connection.command(`${db}.$cmd`, saslContinue, err => {\n          if (err) return callback(err);\n          callback();\n        });\n      });\n    });\n  }\n}\n\nfunction makeTempCredentials(credentials, callback) {\n  function done(creds) {\n    if (creds.AccessKeyId == null || creds.SecretAccessKey == null || creds.Token == null) {\n      callback(new MongoError('Could not obtain temporary MONGODB-AWS credentials'));\n      return;\n    }\n\n    callback(\n      undefined,\n      new MongoCredentials({\n        username: creds.AccessKeyId,\n        password: creds.SecretAccessKey,\n        source: credentials.source,\n        mechanism: 'MONGODB-AWS',\n        mechanismProperties: {\n          AWS_SESSION_TOKEN: creds.Token\n        }\n      })\n    );\n  }\n\n  // If the environment variable AWS_CONTAINER_CREDENTIALS_RELATIVE_URI\n  // is set then drivers MUST assume that it was set by an AWS ECS agent\n  if (process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI) {\n    request(\n      `${AWS_RELATIVE_URI}${process.env.AWS_CONTAINER_CREDENTIALS_RELATIVE_URI}`,\n      (err, res) => {\n        if (err) return callback(err);\n        done(res);\n      }\n    );\n\n    return;\n  }\n\n  // Otherwise assume we are on an EC2 instance\n\n  // get a token\n\n  request(\n    `${AWS_EC2_URI}/latest/api/token`,\n    { method: 'PUT', json: false, headers: { 'X-aws-ec2-metadata-token-ttl-seconds': 30 } },\n    (err, token) => {\n      if (err) return callback(err);\n\n      // get role name\n      request(\n        `${AWS_EC2_URI}/${AWS_EC2_PATH}`,\n        { json: false, headers: { 'X-aws-ec2-metadata-token': token } },\n        (err, roleName) => {\n          if (err) return callback(err);\n\n          // get temp credentials\n          request(\n            `${AWS_EC2_URI}/${AWS_EC2_PATH}/${roleName}`,\n            { headers: { 'X-aws-ec2-metadata-token': token } },\n            (err, creds) => {\n              if (err) return callback(err);\n              done(creds);\n            }\n          );\n        }\n      );\n    }\n  );\n}\n\nfunction deriveRegion(host) {\n  const parts = host.split('.');\n  if (parts.length === 1 || parts[1] === 'amazonaws') {\n    return 'us-east-1';\n  }\n\n  return parts[1];\n}\n\nfunction request(uri, options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  options = Object.assign(\n    {\n      method: 'GET',\n      timeout: 10000,\n      json: true\n    },\n    url.parse(uri),\n    options\n  );\n\n  const req = http.request(options, res => {\n    res.setEncoding('utf8');\n\n    let data = '';\n    res.on('data', d => (data += d));\n    res.on('end', () => {\n      if (options.json === false) {\n        callback(undefined, data);\n        return;\n      }\n\n      try {\n        const parsed = JSON.parse(data);\n        callback(undefined, parsed);\n      } catch (err) {\n        callback(new MongoError(`Invalid JSON response: \"${data}\"`));\n      }\n    });\n  });\n\n  req.on('error', err => callback(err));\n  req.end();\n}\n\nmodule.exports = MongoDBAWS;\n"]},"metadata":{},"sourceType":"script"}