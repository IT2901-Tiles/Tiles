{"ast":null,"code":"'use strict';\n\nconst Query = require('../connection/commands').Query;\n\nconst MongoError = require('../error').MongoError;\n\nconst getReadPreference = require('./shared').getReadPreference;\n\nconst collectionNamespace = require('./shared').collectionNamespace;\n\nconst isSharded = require('./shared').isSharded;\n\nconst maxWireVersion = require('../utils').maxWireVersion;\n\nconst applyCommonQueryOptions = require('./shared').applyCommonQueryOptions;\n\nconst command = require('./command');\n\nconst decorateWithExplain = require('../../utils').decorateWithExplain;\n\nconst Explain = require('../../explain').Explain;\n\nfunction query(server, ns, cmd, cursorState, options, callback) {\n  options = options || {};\n\n  if (cursorState.cursorId != null) {\n    return callback();\n  }\n\n  if (cmd == null) {\n    return callback(new MongoError(`command ${JSON.stringify(cmd)} does not return a cursor`));\n  }\n\n  if (maxWireVersion(server) < 4) {\n    const query = prepareLegacyFindQuery(server, ns, cmd, cursorState, options);\n    const queryOptions = applyCommonQueryOptions({}, cursorState);\n\n    if (typeof query.documentsReturnedIn === 'string') {\n      queryOptions.documentsReturnedIn = query.documentsReturnedIn;\n    }\n\n    server.s.pool.write(query, queryOptions, callback);\n    return;\n  }\n\n  const readPreference = getReadPreference(cmd, options);\n  let findCmd = prepareFindCommand(server, ns, cmd, cursorState, options); // If we have explain, we need to rewrite the find command\n  // to wrap it in the explain command\n\n  const explain = Explain.fromOptions(options);\n\n  if (explain) {\n    findCmd = decorateWithExplain(findCmd, explain);\n  } // NOTE: This actually modifies the passed in cmd, and our code _depends_ on this\n  //       side-effect. Change this ASAP\n\n\n  cmd.virtual = false;\n  const commandOptions = Object.assign({\n    documentsReturnedIn: 'firstBatch',\n    numberToReturn: 1,\n    slaveOk: readPreference.slaveOk()\n  }, options);\n\n  if (cmd.readPreference) {\n    commandOptions.readPreference = readPreference;\n  }\n\n  if (cursorState.session) {\n    commandOptions.session = cursorState.session;\n  }\n\n  command(server, ns, findCmd, commandOptions, callback);\n}\n\nfunction prepareFindCommand(server, ns, cmd, cursorState) {\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n  const findCmd = {\n    find: collectionNamespace(ns)\n  };\n\n  if (cmd.query) {\n    if (cmd.query['$query']) {\n      findCmd.filter = cmd.query['$query'];\n    } else {\n      findCmd.filter = cmd.query;\n    }\n  }\n\n  let sortValue = cmd.sort;\n\n  if (Array.isArray(sortValue)) {\n    const sortObject = {};\n\n    if (sortValue.length > 0 && !Array.isArray(sortValue[0])) {\n      let sortDirection = sortValue[1];\n\n      if (sortDirection === 'asc') {\n        sortDirection = 1;\n      } else if (sortDirection === 'desc') {\n        sortDirection = -1;\n      }\n\n      sortObject[sortValue[0]] = sortDirection;\n    } else {\n      for (let i = 0; i < sortValue.length; i++) {\n        let sortDirection = sortValue[i][1];\n\n        if (sortDirection === 'asc') {\n          sortDirection = 1;\n        } else if (sortDirection === 'desc') {\n          sortDirection = -1;\n        }\n\n        sortObject[sortValue[i][0]] = sortDirection;\n      }\n    }\n\n    sortValue = sortObject;\n  }\n\n  if (typeof cmd.allowDiskUse === 'boolean') {\n    findCmd.allowDiskUse = cmd.allowDiskUse;\n  }\n\n  if (cmd.sort) findCmd.sort = sortValue;\n  if (cmd.fields) findCmd.projection = cmd.fields;\n  if (cmd.hint) findCmd.hint = cmd.hint;\n  if (cmd.skip) findCmd.skip = cmd.skip;\n  if (cmd.limit) findCmd.limit = cmd.limit;\n\n  if (cmd.limit < 0) {\n    findCmd.limit = Math.abs(cmd.limit);\n    findCmd.singleBatch = true;\n  }\n\n  if (typeof cmd.batchSize === 'number') {\n    if (cmd.batchSize < 0) {\n      if (cmd.limit !== 0 && Math.abs(cmd.batchSize) < Math.abs(cmd.limit)) {\n        findCmd.limit = Math.abs(cmd.batchSize);\n      }\n\n      findCmd.singleBatch = true;\n    }\n\n    findCmd.batchSize = Math.abs(cmd.batchSize);\n  }\n\n  if (cmd.comment) findCmd.comment = cmd.comment;\n  if (cmd.maxScan) findCmd.maxScan = cmd.maxScan;\n  if (cmd.maxTimeMS) findCmd.maxTimeMS = cmd.maxTimeMS;\n  if (cmd.min) findCmd.min = cmd.min;\n  if (cmd.max) findCmd.max = cmd.max;\n  findCmd.returnKey = cmd.returnKey ? cmd.returnKey : false;\n  findCmd.showRecordId = cmd.showDiskLoc ? cmd.showDiskLoc : false;\n  if (cmd.snapshot) findCmd.snapshot = cmd.snapshot;\n  if (cmd.tailable) findCmd.tailable = cmd.tailable;\n  if (cmd.oplogReplay) findCmd.oplogReplay = cmd.oplogReplay;\n  if (cmd.noCursorTimeout) findCmd.noCursorTimeout = cmd.noCursorTimeout;\n  if (cmd.awaitData) findCmd.awaitData = cmd.awaitData;\n  if (cmd.awaitdata) findCmd.awaitData = cmd.awaitdata;\n  if (cmd.partial) findCmd.partial = cmd.partial;\n  if (cmd.collation) findCmd.collation = cmd.collation;\n  if (cmd.readConcern) findCmd.readConcern = cmd.readConcern;\n  return findCmd;\n}\n\nfunction prepareLegacyFindQuery(server, ns, cmd, cursorState, options) {\n  options = options || {};\n  const bson = server.s.bson;\n  const readPreference = getReadPreference(cmd, options);\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n  let numberToReturn = 0;\n\n  if (cursorState.limit < 0 || cursorState.limit !== 0 && cursorState.limit < cursorState.batchSize || cursorState.limit > 0 && cursorState.batchSize === 0) {\n    numberToReturn = cursorState.limit;\n  } else {\n    numberToReturn = cursorState.batchSize;\n  }\n\n  const numberToSkip = cursorState.skip || 0;\n  const findCmd = {};\n\n  if (isSharded(server) && readPreference) {\n    findCmd['$readPreference'] = readPreference.toJSON();\n  }\n\n  if (cmd.sort) findCmd['$orderby'] = cmd.sort;\n  if (cmd.hint) findCmd['$hint'] = cmd.hint;\n  if (cmd.snapshot) findCmd['$snapshot'] = cmd.snapshot;\n  if (typeof cmd.returnKey !== 'undefined') findCmd['$returnKey'] = cmd.returnKey;\n  if (cmd.maxScan) findCmd['$maxScan'] = cmd.maxScan;\n  if (cmd.min) findCmd['$min'] = cmd.min;\n  if (cmd.max) findCmd['$max'] = cmd.max;\n  if (typeof cmd.showDiskLoc !== 'undefined') findCmd['$showDiskLoc'] = cmd.showDiskLoc;\n  if (cmd.comment) findCmd['$comment'] = cmd.comment;\n  if (cmd.maxTimeMS) findCmd['$maxTimeMS'] = cmd.maxTimeMS;\n\n  if (options.explain !== undefined) {\n    // nToReturn must be 0 (match all) or negative (match N and close cursor)\n    // nToReturn > 0 will give explain results equivalent to limit(0)\n    numberToReturn = -Math.abs(cmd.limit || 0);\n    findCmd['$explain'] = true;\n  }\n\n  findCmd['$query'] = cmd.query;\n\n  if (cmd.readConcern && cmd.readConcern.level !== 'local') {\n    throw new MongoError(`server find command does not support a readConcern level of ${cmd.readConcern.level}`);\n  }\n\n  if (cmd.readConcern) {\n    cmd = Object.assign({}, cmd);\n    delete cmd['readConcern'];\n  }\n\n  const serializeFunctions = typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;\n  const ignoreUndefined = typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : false;\n  const query = new Query(bson, ns, findCmd, {\n    numberToSkip: numberToSkip,\n    numberToReturn: numberToReturn,\n    pre32Limit: typeof cmd.limit !== 'undefined' ? cmd.limit : undefined,\n    checkKeys: false,\n    returnFieldSelector: cmd.fields,\n    serializeFunctions: serializeFunctions,\n    ignoreUndefined: ignoreUndefined\n  });\n  if (typeof cmd.tailable === 'boolean') query.tailable = cmd.tailable;\n  if (typeof cmd.oplogReplay === 'boolean') query.oplogReplay = cmd.oplogReplay;\n  if (typeof cmd.noCursorTimeout === 'boolean') query.noCursorTimeout = cmd.noCursorTimeout;\n  if (typeof cmd.awaitData === 'boolean') query.awaitData = cmd.awaitData;\n  if (typeof cmd.partial === 'boolean') query.partial = cmd.partial;\n  query.slaveOk = readPreference.slaveOk();\n  return query;\n}\n\nmodule.exports = query;","map":{"version":3,"sources":["C:/Users/StuartGO/projects/bachelorOppgave/Tiles/tiles01/node_modules/mongodb/lib/core/wireprotocol/query.js"],"names":["Query","require","MongoError","getReadPreference","collectionNamespace","isSharded","maxWireVersion","applyCommonQueryOptions","command","decorateWithExplain","Explain","query","server","ns","cmd","cursorState","options","callback","cursorId","JSON","stringify","prepareLegacyFindQuery","queryOptions","documentsReturnedIn","s","pool","write","readPreference","findCmd","prepareFindCommand","explain","fromOptions","virtual","commandOptions","Object","assign","numberToReturn","slaveOk","session","batchSize","find","filter","sortValue","sort","Array","isArray","sortObject","length","sortDirection","i","allowDiskUse","fields","projection","hint","skip","limit","Math","abs","singleBatch","comment","maxScan","maxTimeMS","min","max","returnKey","showRecordId","showDiskLoc","snapshot","tailable","oplogReplay","noCursorTimeout","awaitData","awaitdata","partial","collation","readConcern","bson","numberToSkip","toJSON","undefined","level","serializeFunctions","ignoreUndefined","pre32Limit","checkKeys","returnFieldSelector","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst Query = require('../connection/commands').Query;\nconst MongoError = require('../error').MongoError;\nconst getReadPreference = require('./shared').getReadPreference;\nconst collectionNamespace = require('./shared').collectionNamespace;\nconst isSharded = require('./shared').isSharded;\nconst maxWireVersion = require('../utils').maxWireVersion;\nconst applyCommonQueryOptions = require('./shared').applyCommonQueryOptions;\nconst command = require('./command');\nconst decorateWithExplain = require('../../utils').decorateWithExplain;\nconst Explain = require('../../explain').Explain;\n\nfunction query(server, ns, cmd, cursorState, options, callback) {\n  options = options || {};\n  if (cursorState.cursorId != null) {\n    return callback();\n  }\n\n  if (cmd == null) {\n    return callback(new MongoError(`command ${JSON.stringify(cmd)} does not return a cursor`));\n  }\n\n  if (maxWireVersion(server) < 4) {\n    const query = prepareLegacyFindQuery(server, ns, cmd, cursorState, options);\n    const queryOptions = applyCommonQueryOptions({}, cursorState);\n    if (typeof query.documentsReturnedIn === 'string') {\n      queryOptions.documentsReturnedIn = query.documentsReturnedIn;\n    }\n\n    server.s.pool.write(query, queryOptions, callback);\n    return;\n  }\n\n  const readPreference = getReadPreference(cmd, options);\n  let findCmd = prepareFindCommand(server, ns, cmd, cursorState, options);\n\n  // If we have explain, we need to rewrite the find command\n  // to wrap it in the explain command\n  const explain = Explain.fromOptions(options);\n  if (explain) {\n    findCmd = decorateWithExplain(findCmd, explain);\n  }\n\n  // NOTE: This actually modifies the passed in cmd, and our code _depends_ on this\n  //       side-effect. Change this ASAP\n  cmd.virtual = false;\n\n  const commandOptions = Object.assign(\n    {\n      documentsReturnedIn: 'firstBatch',\n      numberToReturn: 1,\n      slaveOk: readPreference.slaveOk()\n    },\n    options\n  );\n\n  if (cmd.readPreference) {\n    commandOptions.readPreference = readPreference;\n  }\n\n  if (cursorState.session) {\n    commandOptions.session = cursorState.session;\n  }\n\n  command(server, ns, findCmd, commandOptions, callback);\n}\n\nfunction prepareFindCommand(server, ns, cmd, cursorState) {\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n  const findCmd = {\n    find: collectionNamespace(ns)\n  };\n\n  if (cmd.query) {\n    if (cmd.query['$query']) {\n      findCmd.filter = cmd.query['$query'];\n    } else {\n      findCmd.filter = cmd.query;\n    }\n  }\n\n  let sortValue = cmd.sort;\n  if (Array.isArray(sortValue)) {\n    const sortObject = {};\n\n    if (sortValue.length > 0 && !Array.isArray(sortValue[0])) {\n      let sortDirection = sortValue[1];\n      if (sortDirection === 'asc') {\n        sortDirection = 1;\n      } else if (sortDirection === 'desc') {\n        sortDirection = -1;\n      }\n\n      sortObject[sortValue[0]] = sortDirection;\n    } else {\n      for (let i = 0; i < sortValue.length; i++) {\n        let sortDirection = sortValue[i][1];\n        if (sortDirection === 'asc') {\n          sortDirection = 1;\n        } else if (sortDirection === 'desc') {\n          sortDirection = -1;\n        }\n\n        sortObject[sortValue[i][0]] = sortDirection;\n      }\n    }\n\n    sortValue = sortObject;\n  }\n\n  if (typeof cmd.allowDiskUse === 'boolean') {\n    findCmd.allowDiskUse = cmd.allowDiskUse;\n  }\n\n  if (cmd.sort) findCmd.sort = sortValue;\n  if (cmd.fields) findCmd.projection = cmd.fields;\n  if (cmd.hint) findCmd.hint = cmd.hint;\n  if (cmd.skip) findCmd.skip = cmd.skip;\n  if (cmd.limit) findCmd.limit = cmd.limit;\n  if (cmd.limit < 0) {\n    findCmd.limit = Math.abs(cmd.limit);\n    findCmd.singleBatch = true;\n  }\n\n  if (typeof cmd.batchSize === 'number') {\n    if (cmd.batchSize < 0) {\n      if (cmd.limit !== 0 && Math.abs(cmd.batchSize) < Math.abs(cmd.limit)) {\n        findCmd.limit = Math.abs(cmd.batchSize);\n      }\n\n      findCmd.singleBatch = true;\n    }\n\n    findCmd.batchSize = Math.abs(cmd.batchSize);\n  }\n\n  if (cmd.comment) findCmd.comment = cmd.comment;\n  if (cmd.maxScan) findCmd.maxScan = cmd.maxScan;\n  if (cmd.maxTimeMS) findCmd.maxTimeMS = cmd.maxTimeMS;\n  if (cmd.min) findCmd.min = cmd.min;\n  if (cmd.max) findCmd.max = cmd.max;\n  findCmd.returnKey = cmd.returnKey ? cmd.returnKey : false;\n  findCmd.showRecordId = cmd.showDiskLoc ? cmd.showDiskLoc : false;\n  if (cmd.snapshot) findCmd.snapshot = cmd.snapshot;\n  if (cmd.tailable) findCmd.tailable = cmd.tailable;\n  if (cmd.oplogReplay) findCmd.oplogReplay = cmd.oplogReplay;\n  if (cmd.noCursorTimeout) findCmd.noCursorTimeout = cmd.noCursorTimeout;\n  if (cmd.awaitData) findCmd.awaitData = cmd.awaitData;\n  if (cmd.awaitdata) findCmd.awaitData = cmd.awaitdata;\n  if (cmd.partial) findCmd.partial = cmd.partial;\n  if (cmd.collation) findCmd.collation = cmd.collation;\n  if (cmd.readConcern) findCmd.readConcern = cmd.readConcern;\n\n  return findCmd;\n}\n\nfunction prepareLegacyFindQuery(server, ns, cmd, cursorState, options) {\n  options = options || {};\n  const bson = server.s.bson;\n  const readPreference = getReadPreference(cmd, options);\n  cursorState.batchSize = cmd.batchSize || cursorState.batchSize;\n\n  let numberToReturn = 0;\n  if (\n    cursorState.limit < 0 ||\n    (cursorState.limit !== 0 && cursorState.limit < cursorState.batchSize) ||\n    (cursorState.limit > 0 && cursorState.batchSize === 0)\n  ) {\n    numberToReturn = cursorState.limit;\n  } else {\n    numberToReturn = cursorState.batchSize;\n  }\n\n  const numberToSkip = cursorState.skip || 0;\n\n  const findCmd = {};\n  if (isSharded(server) && readPreference) {\n    findCmd['$readPreference'] = readPreference.toJSON();\n  }\n\n  if (cmd.sort) findCmd['$orderby'] = cmd.sort;\n  if (cmd.hint) findCmd['$hint'] = cmd.hint;\n  if (cmd.snapshot) findCmd['$snapshot'] = cmd.snapshot;\n  if (typeof cmd.returnKey !== 'undefined') findCmd['$returnKey'] = cmd.returnKey;\n  if (cmd.maxScan) findCmd['$maxScan'] = cmd.maxScan;\n  if (cmd.min) findCmd['$min'] = cmd.min;\n  if (cmd.max) findCmd['$max'] = cmd.max;\n  if (typeof cmd.showDiskLoc !== 'undefined') findCmd['$showDiskLoc'] = cmd.showDiskLoc;\n  if (cmd.comment) findCmd['$comment'] = cmd.comment;\n  if (cmd.maxTimeMS) findCmd['$maxTimeMS'] = cmd.maxTimeMS;\n  if (options.explain !== undefined) {\n    // nToReturn must be 0 (match all) or negative (match N and close cursor)\n    // nToReturn > 0 will give explain results equivalent to limit(0)\n    numberToReturn = -Math.abs(cmd.limit || 0);\n    findCmd['$explain'] = true;\n  }\n\n  findCmd['$query'] = cmd.query;\n  if (cmd.readConcern && cmd.readConcern.level !== 'local') {\n    throw new MongoError(\n      `server find command does not support a readConcern level of ${cmd.readConcern.level}`\n    );\n  }\n\n  if (cmd.readConcern) {\n    cmd = Object.assign({}, cmd);\n    delete cmd['readConcern'];\n  }\n\n  const serializeFunctions =\n    typeof options.serializeFunctions === 'boolean' ? options.serializeFunctions : false;\n  const ignoreUndefined =\n    typeof options.ignoreUndefined === 'boolean' ? options.ignoreUndefined : false;\n\n  const query = new Query(bson, ns, findCmd, {\n    numberToSkip: numberToSkip,\n    numberToReturn: numberToReturn,\n    pre32Limit: typeof cmd.limit !== 'undefined' ? cmd.limit : undefined,\n    checkKeys: false,\n    returnFieldSelector: cmd.fields,\n    serializeFunctions: serializeFunctions,\n    ignoreUndefined: ignoreUndefined\n  });\n\n  if (typeof cmd.tailable === 'boolean') query.tailable = cmd.tailable;\n  if (typeof cmd.oplogReplay === 'boolean') query.oplogReplay = cmd.oplogReplay;\n  if (typeof cmd.noCursorTimeout === 'boolean') query.noCursorTimeout = cmd.noCursorTimeout;\n  if (typeof cmd.awaitData === 'boolean') query.awaitData = cmd.awaitData;\n  if (typeof cmd.partial === 'boolean') query.partial = cmd.partial;\n\n  query.slaveOk = readPreference.slaveOk();\n  return query;\n}\n\nmodule.exports = query;\n"]},"metadata":{},"sourceType":"script"}