{"ast":null,"code":"'use strict';\n\nconst EventEmitter = require('events'),\n      MongoError = require('../core').MongoError,\n      f = require('util').format,\n      ReadPreference = require('../core').ReadPreference,\n      ClientSession = require('../core').Sessions.ClientSession; // The store of ops\n\n\nvar Store = function (topology, storeOptions) {\n  var self = this;\n  var storedOps = [];\n  storeOptions = storeOptions || {\n    force: false,\n    bufferMaxEntries: -1\n  }; // Internal state\n\n  this.s = {\n    storedOps: storedOps,\n    storeOptions: storeOptions,\n    topology: topology\n  };\n  Object.defineProperty(this, 'length', {\n    enumerable: true,\n    get: function () {\n      return self.s.storedOps.length;\n    }\n  });\n};\n\nStore.prototype.add = function (opType, ns, ops, options, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({\n      message: 'db closed by application',\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(MongoError.create({\n      message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries > 0 && this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(MongoError.create({\n        message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n        driver: true\n      }));\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({\n    t: opType,\n    n: ns,\n    o: ops,\n    op: options,\n    c: callback\n  });\n};\n\nStore.prototype.addObjectAndMethod = function (opType, object, method, params, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({\n      message: 'db closed by application',\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(MongoError.create({\n      message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n      driver: true\n    }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries > 0 && this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(MongoError.create({\n        message: f('no connection available for operation and number of stored operation > %s', this.s.storeOptions.bufferMaxEntries),\n        driver: true\n      }));\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({\n    t: opType,\n    m: method,\n    o: object,\n    p: params,\n    c: callback\n  });\n};\n\nStore.prototype.flush = function (err) {\n  while (this.s.storedOps.length > 0) {\n    this.s.storedOps.shift().c(err || MongoError.create({\n      message: f('no connection available for operation'),\n      driver: true\n    }));\n  }\n};\n\nvar primaryOptions = ['primary', 'primaryPreferred', 'nearest', 'secondaryPreferred'];\nvar secondaryOptions = ['secondary', 'secondaryPreferred'];\n\nStore.prototype.execute = function (options) {\n  options = options || {}; // Get current ops\n\n  var ops = this.s.storedOps; // Reset the ops\n\n  this.s.storedOps = []; // Unpack options\n\n  var executePrimary = typeof options.executePrimary === 'boolean' ? options.executePrimary : true;\n  var executeSecondary = typeof options.executeSecondary === 'boolean' ? options.executeSecondary : true; // Execute all the stored ops\n\n  while (ops.length > 0) {\n    var op = ops.shift();\n\n    if (op.t === 'cursor') {\n      if (executePrimary && executeSecondary) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (executePrimary && op.o.options && op.o.options.readPreference && primaryOptions.indexOf(op.o.options.readPreference.mode) !== -1) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (!executePrimary && executeSecondary && op.o.options && op.o.options.readPreference && secondaryOptions.indexOf(op.o.options.readPreference.mode) !== -1) {\n        op.o[op.m].apply(op.o, op.p);\n      }\n    } else if (op.t === 'auth') {\n      this.s.topology[op.t].apply(this.s.topology, op.o);\n    } else {\n      if (executePrimary && executeSecondary) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (executePrimary && op.op && op.op.readPreference && primaryOptions.indexOf(op.op.readPreference.mode) !== -1) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (!executePrimary && executeSecondary && op.op && op.op.readPreference && secondaryOptions.indexOf(op.op.readPreference.mode) !== -1) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      }\n    }\n  }\n};\n\nStore.prototype.all = function () {\n  return this.s.storedOps;\n}; // Server capabilities\n\n\nvar ServerCapabilities = function (ismaster) {\n  var setup_get_property = function (object, name, value) {\n    Object.defineProperty(object, name, {\n      enumerable: true,\n      get: function () {\n        return value;\n      }\n    });\n  }; // Capabilities\n\n\n  var aggregationCursor = false;\n  var writeCommands = false;\n  var textSearch = false;\n  var authCommands = false;\n  var listCollections = false;\n  var listIndexes = false;\n  var maxNumberOfDocsInBatch = ismaster.maxWriteBatchSize || 1000;\n  var commandsTakeWriteConcern = false;\n  var commandsTakeCollation = false;\n\n  if (ismaster.minWireVersion >= 0) {\n    textSearch = true;\n  }\n\n  if (ismaster.maxWireVersion >= 1) {\n    aggregationCursor = true;\n    authCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 2) {\n    writeCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 3) {\n    listCollections = true;\n    listIndexes = true;\n  }\n\n  if (ismaster.maxWireVersion >= 5) {\n    commandsTakeWriteConcern = true;\n    commandsTakeCollation = true;\n  } // If no min or max wire version set to 0\n\n\n  if (ismaster.minWireVersion == null) {\n    ismaster.minWireVersion = 0;\n  }\n\n  if (ismaster.maxWireVersion == null) {\n    ismaster.maxWireVersion = 0;\n  } // Map up read only parameters\n\n\n  setup_get_property(this, 'hasAggregationCursor', aggregationCursor);\n  setup_get_property(this, 'hasWriteCommands', writeCommands);\n  setup_get_property(this, 'hasTextSearch', textSearch);\n  setup_get_property(this, 'hasAuthCommands', authCommands);\n  setup_get_property(this, 'hasListCollectionsCommand', listCollections);\n  setup_get_property(this, 'hasListIndexesCommand', listIndexes);\n  setup_get_property(this, 'minWireVersion', ismaster.minWireVersion);\n  setup_get_property(this, 'maxWireVersion', ismaster.maxWireVersion);\n  setup_get_property(this, 'maxNumberOfDocsInBatch', maxNumberOfDocsInBatch);\n  setup_get_property(this, 'commandsTakeWriteConcern', commandsTakeWriteConcern);\n  setup_get_property(this, 'commandsTakeCollation', commandsTakeCollation);\n};\n\nclass TopologyBase extends EventEmitter {\n  constructor() {\n    super();\n    this.setMaxListeners(Infinity);\n  } // Sessions related methods\n\n\n  hasSessionSupport() {\n    return this.logicalSessionTimeoutMinutes != null;\n  }\n\n  startSession(options, clientOptions) {\n    const session = new ClientSession(this, this.s.sessionPool, options, clientOptions);\n    session.once('ended', () => {\n      this.s.sessions.delete(session);\n    });\n    this.s.sessions.add(session);\n    return session;\n  }\n\n  endSessions(sessions, callback) {\n    return this.s.coreTopology.endSessions(sessions, callback);\n  }\n\n  get clientMetadata() {\n    return this.s.coreTopology.s.options.metadata;\n  } // Server capabilities\n\n\n  capabilities() {\n    if (this.s.sCapabilities) return this.s.sCapabilities;\n    if (this.s.coreTopology.lastIsMaster() == null) return null;\n    this.s.sCapabilities = new ServerCapabilities(this.s.coreTopology.lastIsMaster());\n    return this.s.sCapabilities;\n  } // Command\n\n\n  command(ns, cmd, options, callback) {\n    this.s.coreTopology.command(ns.toString(), cmd, ReadPreference.translate(options), callback);\n  } // Insert\n\n\n  insert(ns, ops, options, callback) {\n    this.s.coreTopology.insert(ns.toString(), ops, options, callback);\n  } // Update\n\n\n  update(ns, ops, options, callback) {\n    this.s.coreTopology.update(ns.toString(), ops, options, callback);\n  } // Remove\n\n\n  remove(ns, ops, options, callback) {\n    this.s.coreTopology.remove(ns.toString(), ops, options, callback);\n  } // IsConnected\n\n\n  isConnected(options) {\n    options = options || {};\n    options = ReadPreference.translate(options);\n    return this.s.coreTopology.isConnected(options);\n  } // IsDestroyed\n\n\n  isDestroyed() {\n    return this.s.coreTopology.isDestroyed();\n  } // Cursor\n\n\n  cursor(ns, cmd, options) {\n    options = options || {};\n    options = ReadPreference.translate(options);\n    options.disconnectHandler = this.s.store;\n    options.topology = this;\n    return this.s.coreTopology.cursor(ns, cmd, options);\n  }\n\n  lastIsMaster() {\n    return this.s.coreTopology.lastIsMaster();\n  }\n\n  selectServer(selector, options, callback) {\n    return this.s.coreTopology.selectServer(selector, options, callback);\n  }\n  /**\n   * Unref all sockets\n   * @method\n   */\n\n\n  unref() {\n    return this.s.coreTopology.unref();\n  }\n  /**\n   * All raw connections\n   * @method\n   * @return {array}\n   */\n\n\n  connections() {\n    return this.s.coreTopology.connections();\n  }\n\n  close(forceClosed, callback) {\n    // If we have sessions, we want to individually move them to the session pool,\n    // and then send a single endSessions call.\n    this.s.sessions.forEach(session => session.endSession());\n\n    if (this.s.sessionPool) {\n      this.s.sessionPool.endAllPooledSessions();\n    } // We need to wash out all stored processes\n\n\n    if (forceClosed === true) {\n      this.s.storeOptions.force = forceClosed;\n      this.s.store.flush();\n    }\n\n    this.s.coreTopology.destroy({\n      force: typeof forceClosed === 'boolean' ? forceClosed : false\n    }, callback);\n  }\n\n} // Properties\n\n\nObject.defineProperty(TopologyBase.prototype, 'bson', {\n  enumerable: true,\n  get: function () {\n    return this.s.coreTopology.s.bson;\n  }\n});\nObject.defineProperty(TopologyBase.prototype, 'parserType', {\n  enumerable: true,\n  get: function () {\n    return this.s.coreTopology.parserType;\n  }\n});\nObject.defineProperty(TopologyBase.prototype, 'logicalSessionTimeoutMinutes', {\n  enumerable: true,\n  get: function () {\n    return this.s.coreTopology.logicalSessionTimeoutMinutes;\n  }\n});\nObject.defineProperty(TopologyBase.prototype, 'type', {\n  enumerable: true,\n  get: function () {\n    return this.s.coreTopology.type;\n  }\n});\nexports.Store = Store;\nexports.ServerCapabilities = ServerCapabilities;\nexports.TopologyBase = TopologyBase;","map":{"version":3,"sources":["C:/Users/StuartGO/projects/bachelorOppgave/Tiles/tiles01/node_modules/mongodb/lib/topologies/topology_base.js"],"names":["EventEmitter","require","MongoError","f","format","ReadPreference","ClientSession","Sessions","Store","topology","storeOptions","self","storedOps","force","bufferMaxEntries","s","Object","defineProperty","enumerable","get","length","prototype","add","opType","ns","ops","options","callback","create","message","driver","op","shift","c","push","t","n","o","addObjectAndMethod","object","method","params","m","p","flush","err","primaryOptions","secondaryOptions","execute","executePrimary","executeSecondary","apply","readPreference","indexOf","mode","all","ServerCapabilities","ismaster","setup_get_property","name","value","aggregationCursor","writeCommands","textSearch","authCommands","listCollections","listIndexes","maxNumberOfDocsInBatch","maxWriteBatchSize","commandsTakeWriteConcern","commandsTakeCollation","minWireVersion","maxWireVersion","TopologyBase","constructor","setMaxListeners","Infinity","hasSessionSupport","logicalSessionTimeoutMinutes","startSession","clientOptions","session","sessionPool","once","sessions","delete","endSessions","coreTopology","clientMetadata","metadata","capabilities","sCapabilities","lastIsMaster","command","cmd","toString","translate","insert","update","remove","isConnected","isDestroyed","cursor","disconnectHandler","store","selectServer","selector","unref","connections","close","forceClosed","forEach","endSession","endAllPooledSessions","destroy","bson","parserType","type","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst EventEmitter = require('events'),\n  MongoError = require('../core').MongoError,\n  f = require('util').format,\n  ReadPreference = require('../core').ReadPreference,\n  ClientSession = require('../core').Sessions.ClientSession;\n\n// The store of ops\nvar Store = function(topology, storeOptions) {\n  var self = this;\n  var storedOps = [];\n  storeOptions = storeOptions || { force: false, bufferMaxEntries: -1 };\n\n  // Internal state\n  this.s = {\n    storedOps: storedOps,\n    storeOptions: storeOptions,\n    topology: topology\n  };\n\n  Object.defineProperty(this, 'length', {\n    enumerable: true,\n    get: function() {\n      return self.s.storedOps.length;\n    }\n  });\n};\n\nStore.prototype.add = function(opType, ns, ops, options, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({ message: 'db closed by application', driver: true }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(\n      MongoError.create({\n        message: f(\n          'no connection available for operation and number of stored operation > %s',\n          this.s.storeOptions.bufferMaxEntries\n        ),\n        driver: true\n      })\n    );\n  }\n\n  if (\n    this.s.storeOptions.bufferMaxEntries > 0 &&\n    this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries\n  ) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(\n        MongoError.create({\n          message: f(\n            'no connection available for operation and number of stored operation > %s',\n            this.s.storeOptions.bufferMaxEntries\n          ),\n          driver: true\n        })\n      );\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({ t: opType, n: ns, o: ops, op: options, c: callback });\n};\n\nStore.prototype.addObjectAndMethod = function(opType, object, method, params, callback) {\n  if (this.s.storeOptions.force) {\n    return callback(MongoError.create({ message: 'db closed by application', driver: true }));\n  }\n\n  if (this.s.storeOptions.bufferMaxEntries === 0) {\n    return callback(\n      MongoError.create({\n        message: f(\n          'no connection available for operation and number of stored operation > %s',\n          this.s.storeOptions.bufferMaxEntries\n        ),\n        driver: true\n      })\n    );\n  }\n\n  if (\n    this.s.storeOptions.bufferMaxEntries > 0 &&\n    this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries\n  ) {\n    while (this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(\n        MongoError.create({\n          message: f(\n            'no connection available for operation and number of stored operation > %s',\n            this.s.storeOptions.bufferMaxEntries\n          ),\n          driver: true\n        })\n      );\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({ t: opType, m: method, o: object, p: params, c: callback });\n};\n\nStore.prototype.flush = function(err) {\n  while (this.s.storedOps.length > 0) {\n    this.s.storedOps\n      .shift()\n      .c(\n        err ||\n          MongoError.create({ message: f('no connection available for operation'), driver: true })\n      );\n  }\n};\n\nvar primaryOptions = ['primary', 'primaryPreferred', 'nearest', 'secondaryPreferred'];\nvar secondaryOptions = ['secondary', 'secondaryPreferred'];\n\nStore.prototype.execute = function(options) {\n  options = options || {};\n  // Get current ops\n  var ops = this.s.storedOps;\n  // Reset the ops\n  this.s.storedOps = [];\n\n  // Unpack options\n  var executePrimary = typeof options.executePrimary === 'boolean' ? options.executePrimary : true;\n  var executeSecondary =\n    typeof options.executeSecondary === 'boolean' ? options.executeSecondary : true;\n\n  // Execute all the stored ops\n  while (ops.length > 0) {\n    var op = ops.shift();\n\n    if (op.t === 'cursor') {\n      if (executePrimary && executeSecondary) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (\n        executePrimary &&\n        op.o.options &&\n        op.o.options.readPreference &&\n        primaryOptions.indexOf(op.o.options.readPreference.mode) !== -1\n      ) {\n        op.o[op.m].apply(op.o, op.p);\n      } else if (\n        !executePrimary &&\n        executeSecondary &&\n        op.o.options &&\n        op.o.options.readPreference &&\n        secondaryOptions.indexOf(op.o.options.readPreference.mode) !== -1\n      ) {\n        op.o[op.m].apply(op.o, op.p);\n      }\n    } else if (op.t === 'auth') {\n      this.s.topology[op.t].apply(this.s.topology, op.o);\n    } else {\n      if (executePrimary && executeSecondary) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (\n        executePrimary &&\n        op.op &&\n        op.op.readPreference &&\n        primaryOptions.indexOf(op.op.readPreference.mode) !== -1\n      ) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      } else if (\n        !executePrimary &&\n        executeSecondary &&\n        op.op &&\n        op.op.readPreference &&\n        secondaryOptions.indexOf(op.op.readPreference.mode) !== -1\n      ) {\n        this.s.topology[op.t](op.n, op.o, op.op, op.c);\n      }\n    }\n  }\n};\n\nStore.prototype.all = function() {\n  return this.s.storedOps;\n};\n\n// Server capabilities\nvar ServerCapabilities = function(ismaster) {\n  var setup_get_property = function(object, name, value) {\n    Object.defineProperty(object, name, {\n      enumerable: true,\n      get: function() {\n        return value;\n      }\n    });\n  };\n\n  // Capabilities\n  var aggregationCursor = false;\n  var writeCommands = false;\n  var textSearch = false;\n  var authCommands = false;\n  var listCollections = false;\n  var listIndexes = false;\n  var maxNumberOfDocsInBatch = ismaster.maxWriteBatchSize || 1000;\n  var commandsTakeWriteConcern = false;\n  var commandsTakeCollation = false;\n\n  if (ismaster.minWireVersion >= 0) {\n    textSearch = true;\n  }\n\n  if (ismaster.maxWireVersion >= 1) {\n    aggregationCursor = true;\n    authCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 2) {\n    writeCommands = true;\n  }\n\n  if (ismaster.maxWireVersion >= 3) {\n    listCollections = true;\n    listIndexes = true;\n  }\n\n  if (ismaster.maxWireVersion >= 5) {\n    commandsTakeWriteConcern = true;\n    commandsTakeCollation = true;\n  }\n\n  // If no min or max wire version set to 0\n  if (ismaster.minWireVersion == null) {\n    ismaster.minWireVersion = 0;\n  }\n\n  if (ismaster.maxWireVersion == null) {\n    ismaster.maxWireVersion = 0;\n  }\n\n  // Map up read only parameters\n  setup_get_property(this, 'hasAggregationCursor', aggregationCursor);\n  setup_get_property(this, 'hasWriteCommands', writeCommands);\n  setup_get_property(this, 'hasTextSearch', textSearch);\n  setup_get_property(this, 'hasAuthCommands', authCommands);\n  setup_get_property(this, 'hasListCollectionsCommand', listCollections);\n  setup_get_property(this, 'hasListIndexesCommand', listIndexes);\n  setup_get_property(this, 'minWireVersion', ismaster.minWireVersion);\n  setup_get_property(this, 'maxWireVersion', ismaster.maxWireVersion);\n  setup_get_property(this, 'maxNumberOfDocsInBatch', maxNumberOfDocsInBatch);\n  setup_get_property(this, 'commandsTakeWriteConcern', commandsTakeWriteConcern);\n  setup_get_property(this, 'commandsTakeCollation', commandsTakeCollation);\n};\n\nclass TopologyBase extends EventEmitter {\n  constructor() {\n    super();\n    this.setMaxListeners(Infinity);\n  }\n\n  // Sessions related methods\n  hasSessionSupport() {\n    return this.logicalSessionTimeoutMinutes != null;\n  }\n\n  startSession(options, clientOptions) {\n    const session = new ClientSession(this, this.s.sessionPool, options, clientOptions);\n\n    session.once('ended', () => {\n      this.s.sessions.delete(session);\n    });\n\n    this.s.sessions.add(session);\n    return session;\n  }\n\n  endSessions(sessions, callback) {\n    return this.s.coreTopology.endSessions(sessions, callback);\n  }\n\n  get clientMetadata() {\n    return this.s.coreTopology.s.options.metadata;\n  }\n\n  // Server capabilities\n  capabilities() {\n    if (this.s.sCapabilities) return this.s.sCapabilities;\n    if (this.s.coreTopology.lastIsMaster() == null) return null;\n    this.s.sCapabilities = new ServerCapabilities(this.s.coreTopology.lastIsMaster());\n    return this.s.sCapabilities;\n  }\n\n  // Command\n  command(ns, cmd, options, callback) {\n    this.s.coreTopology.command(ns.toString(), cmd, ReadPreference.translate(options), callback);\n  }\n\n  // Insert\n  insert(ns, ops, options, callback) {\n    this.s.coreTopology.insert(ns.toString(), ops, options, callback);\n  }\n\n  // Update\n  update(ns, ops, options, callback) {\n    this.s.coreTopology.update(ns.toString(), ops, options, callback);\n  }\n\n  // Remove\n  remove(ns, ops, options, callback) {\n    this.s.coreTopology.remove(ns.toString(), ops, options, callback);\n  }\n\n  // IsConnected\n  isConnected(options) {\n    options = options || {};\n    options = ReadPreference.translate(options);\n\n    return this.s.coreTopology.isConnected(options);\n  }\n\n  // IsDestroyed\n  isDestroyed() {\n    return this.s.coreTopology.isDestroyed();\n  }\n\n  // Cursor\n  cursor(ns, cmd, options) {\n    options = options || {};\n    options = ReadPreference.translate(options);\n    options.disconnectHandler = this.s.store;\n    options.topology = this;\n\n    return this.s.coreTopology.cursor(ns, cmd, options);\n  }\n\n  lastIsMaster() {\n    return this.s.coreTopology.lastIsMaster();\n  }\n\n  selectServer(selector, options, callback) {\n    return this.s.coreTopology.selectServer(selector, options, callback);\n  }\n\n  /**\n   * Unref all sockets\n   * @method\n   */\n  unref() {\n    return this.s.coreTopology.unref();\n  }\n\n  /**\n   * All raw connections\n   * @method\n   * @return {array}\n   */\n  connections() {\n    return this.s.coreTopology.connections();\n  }\n\n  close(forceClosed, callback) {\n    // If we have sessions, we want to individually move them to the session pool,\n    // and then send a single endSessions call.\n    this.s.sessions.forEach(session => session.endSession());\n\n    if (this.s.sessionPool) {\n      this.s.sessionPool.endAllPooledSessions();\n    }\n\n    // We need to wash out all stored processes\n    if (forceClosed === true) {\n      this.s.storeOptions.force = forceClosed;\n      this.s.store.flush();\n    }\n\n    this.s.coreTopology.destroy(\n      {\n        force: typeof forceClosed === 'boolean' ? forceClosed : false\n      },\n      callback\n    );\n  }\n}\n\n// Properties\nObject.defineProperty(TopologyBase.prototype, 'bson', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.s.bson;\n  }\n});\n\nObject.defineProperty(TopologyBase.prototype, 'parserType', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.parserType;\n  }\n});\n\nObject.defineProperty(TopologyBase.prototype, 'logicalSessionTimeoutMinutes', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.logicalSessionTimeoutMinutes;\n  }\n});\n\nObject.defineProperty(TopologyBase.prototype, 'type', {\n  enumerable: true,\n  get: function() {\n    return this.s.coreTopology.type;\n  }\n});\n\nexports.Store = Store;\nexports.ServerCapabilities = ServerCapabilities;\nexports.TopologyBase = TopologyBase;\n"]},"metadata":{},"sourceType":"script"}